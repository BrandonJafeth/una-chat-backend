name: Build, Scan (Grype) and Push - Backend

on:
  push:
    branches: [ "main", "development" ]
  pull_request:
    branches: [ "main", "development" ]
  workflow_dispatch:

jobs:
  build_scan_push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write

    env:
      DOCKERHUB_REPO: unachat/unachat
      IMAGE: unachat/unachat:development

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build development image
        run: |
          docker build -t $IMAGE .

      # --- Instalar Grype (CLI oficial de Anchore) ---
      - name: Install Grype
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh \
            | sh -s -- -b /usr/local/bin

      # 1) Mostrar TABLA en logs (no bloquea el pipeline)
      - name: Grype table (non-blocking)
        run: |
          grype $IMAGE -o table || true

      # 2) Generar SARIF para Security (no bloquea; si falla igual seguimos)
      - name: Grype SARIF (non-blocking)
        run: |
          grype $IMAGE -o sarif > grype.sarif || true

      - name: Upload SARIF to GitHub Security
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: grype.sarif

      # 3) Gate de severidad: falla si hay CRITICAL
      - name: Grype severity gate (fail on CRITICAL)
        run: |
          grype $IMAGE --fail-on critical -o json > /dev/null

      # 4) Push solo si pas√≥ el gate
      - name: Docker login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Push image (development and sha)
        run: |
          SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
          docker push $IMAGE
          docker push $DOCKERHUB_REPO:sha-$SHORT_SHA
