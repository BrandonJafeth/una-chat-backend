name: Backend SSDLC (Lint + Tests + Snyk + Build)

on:
  workflow_dispatch:
  push:
    branches: ["main", "develop"]
  pull_request:
    branches: ["main", "develop"]

permissions:
  contents: read

jobs:
  # 1) LINT
  lint:
    name: Lint (ESLint)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run lint   # debe fallar con warnings (--max-warnings=0)

  # 2) TESTS
  test:
    name: Unit Tests (Jest)
    runs-on: ubuntu-latest
    needs: [lint]           # ⛔ solo corre si Lint pasa
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run test:ci

  # 3) SNYK
  snyk:
    name: Snyk Security (SAST + SCA + optional IaC/Container)
    runs-on: ubuntu-latest
    needs: [test]           # ⛔ solo corre si Tests pasan
    permissions:
      contents: read
      security-events: write
      actions: read
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install deps
        run: npm ci

      - name: Setup Snyk CLI
        uses: snyk/actions/setup@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # --- Snyk Code (SAST) ---
      - name: Snyk Code test (SAST)
        run: snyk code test --severity-threshold=high --sarif-file-output=snyk-code.sarif
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Upload SARIF to GitHub Code Scanning
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: snyk-code.sarif

      # --- Snyk Open Source (SCA) ---
      - name: Snyk Open Source test (SCA)
        run: snyk test --severity-threshold=high --fail-on=all --all-projects
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      - name: Snyk Open Source monitor
        run: snyk monitor --all-projects
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # --- IaC (condicional - solo si hay archivos Terraform/Kubernetes) ---
      # Nota: Este proyecto backend no tiene IaC, por lo que este paso normalmente se salta
      - name: Detect IaC files
        id: detect_iac
        run: |
          # Buscar solo archivos de IaC relevantes (Terraform, CloudFormation, Kubernetes)
          # Excluir node_modules, dist, coverage, .github/workflows para evitar falsos positivos
          iac_files=$(find . -type f \( -name "*.tf" -o -name "*.tfvars" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*" \
            ! -path "*/dist/*" \
            ! -path "*/coverage/*" 2>/dev/null || true)
          
          k8s_files=$(find . -type f \( -name "*deployment*.yaml" -o -name "*deployment*.yml" \
            -o -name "*service*.yaml" -o -name "*service*.yml" \
            -o -name "*ingress*.yaml" -o -name "*ingress*.yml" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/.git/*" \
            ! -path "*/.github/*" 2>/dev/null || true)
          
          if [ -n "$iac_files" ] || [ -n "$k8s_files" ]; then
            echo "found=true" >> "$GITHUB_OUTPUT"
            echo "Found IaC files to scan"
            [ -n "$iac_files" ] && echo "Terraform: $iac_files"
            [ -n "$k8s_files" ] && echo "Kubernetes: $k8s_files"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
            echo "No IaC files found (Terraform/Kubernetes only)"
          fi

      - name: Snyk IaC test and report
        if: steps.detect_iac.outputs.found == 'true'
        run: |
          # Escanear solo directorios con archivos IaC reales, excluyendo node_modules
          snyk iac test . \
            --severity-threshold=high \
            --report \
            --detection-depth=3 \
            || echo "IaC scan completed with findings or errors"
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

      # --- Container (condicional) ---
      - name: Check Dockerfile
        id: dockerfile
        run: |
          if [ -f Dockerfile ]; then
            echo "present=true" >> "$GITHUB_OUTPUT"
          else
            echo "present=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Build a Docker image
        if: steps.dockerfile.outputs.present == 'true'
        run: docker build -t backend-under-test .

      - name: Snyk Container monitor
        if: steps.dockerfile.outputs.present == 'true'
        run: snyk container monitor backend-under-test --file=Dockerfile
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  # 4) BUILD
  build:
    name: Build (tsc)
    runs-on: ubuntu-latest
    needs: [snyk]           # ✅ solo si todo lo anterior pasó
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: npm run build
